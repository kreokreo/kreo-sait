#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ VPS ÑÐµÑ€Ð²ÐµÑ€Ð°
# Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root Ð¸Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· sudo

set -e

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPS ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Kreo IT"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt-get update
apt-get upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker
if ! command -v docker &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose..."
    apt-get install -y docker-compose-plugin
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Nginx
if ! command -v nginx &> /dev/null; then
    echo "ðŸŒ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Nginx..."
    apt-get install -y nginx
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot Ð´Ð»Ñ SSL
if ! command -v certbot &> /dev/null; then
    echo "ðŸ”’ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot..."
    apt-get install -y certbot python3-certbot-nginx
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p /opt/kreo-it
mkdir -p /var/www/kreo-it/production
mkdir -p /var/log/nginx

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð²
chown -R $USER:$USER /opt/kreo-it
chown -R www-data:www-data /var/www/kreo-it

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd service Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
cat > /etc/systemd/system/kreo-it.service << EOF
[Unit]
Description=Kreo IT Docker Compose
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/kreo-it
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable kreo-it.service

echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ DNS Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° kreo.pro"
echo "2. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚:"
echo "   certbot --nginx -d kreo.pro -d www.kreo.pro"
echo "3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx:"
echo "   cp docker/nginx-production.conf /etc/nginx/sites-available/kreo.pro"
echo "   ln -s /etc/nginx/sites-available/kreo.pro /etc/nginx/sites-enabled/"
echo "4. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Nginx:"
echo "   nginx -t && systemctl reload nginx"

