name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch: # Позволяет запускать вручную из GitHub UI

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint
        continue-on-error: true

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: https://kreo.pro
          NEXT_PUBLIC_API_URL: https://api.kreo.pro

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (optional)
        if: env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -f docker/Dockerfile -t kreo-it:production -t kreo-it:production-${{ github.sha }} .

      - name: Save Docker image
        run: |
          docker save kreo-it:production | gzip > kreo-it-production.tar.gz

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          source: "kreo-it-production.tar.gz,docker-compose.yml,docker/nginx-production.conf"
          strip_components: 0
          target: "/opt/kreo-it/"
          overwrite: true

      - name: Deploy and restart on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            set -e
            cd /opt/kreo-it
            
            # Загрузка образа и деплой в одном шаге
            docker load < kreo-it-production.tar.gz
            
            # Остановка и удаление старого контейнера
            docker stop kreo-it-production 2>/dev/null || true
            docker rm -f kreo-it-production 2>/dev/null || true
            
            # Остановка и удаление старого контейнера
            docker stop kreo-it-production 2>/dev/null || true
            docker rm -f kreo-it-production 2>/dev/null || true
            
            # Запуск нового контейнера с проверкой
            echo "Запуск контейнера..."
            docker run -d \
              --name kreo-it-production \
              --restart unless-stopped \
              -p 3001:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              kreo-it:production
            
            # Ждем запуска
            echo "Ожидание запуска контейнера (15 секунд)..."
            sleep 15
            
            # Проверяем статус
            echo "=== Статус контейнера ==="
            docker ps | grep kreo-it-production || echo "❌ Контейнер не запущен!"
            
            # Проверяем логи
            echo "=== Логи контейнера (последние 30 строк) ==="
            docker logs kreo-it-production --tail 30 || echo "Логи недоступны"
            
            # Проверяем доступность
            echo "=== Проверка доступности ==="
            for i in {1..5}; do
              if curl -f -s -m 3 http://localhost:3001 > /dev/null 2>&1; then
                echo "✅ Приложение доступно на порту 3001!"
                break
              fi
              echo "Попытка $i/5: ждем..."
              sleep 3
            done
            
            # Обновление Nginx
            if [ -f nginx-production.conf ]; then
              sudo cp nginx-production.conf /etc/nginx/sites-available/kreo.pro
              [ -L /etc/nginx/sites-enabled/kreo.pro ] || sudo ln -s /etc/nginx/sites-available/kreo.pro /etc/nginx/sites-enabled/kreo.pro
              sudo nginx -t && sudo systemctl reload nginx
            fi
            
            # Очистка старых образов
            docker image prune -f

      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            sleep 10
            for i in {1..5}; do
              if curl -f -s -m 3 http://localhost:3001 > /dev/null 2>&1; then
                echo "✅ Приложение доступно!"
                exit 0
              fi
              sleep 2
            done
            echo "❌ Health check failed"
            docker ps | grep kreo-it-production
            docker logs kreo-it-production --tail 20
            exit 1


      - name: Notify success
        if: success()
        run: |
          echo "✅ Deployment to kreo.pro successful!"

      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Deployment to kreo.pro failed!"

