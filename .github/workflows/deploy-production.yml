name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch: # Позволяет запускать вручную из GitHub UI

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint
        continue-on-error: true

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: https://kreo.pro
          NEXT_PUBLIC_API_URL: https://api.kreo.pro

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (optional)
        if: env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -f docker/Dockerfile -t kreo-it:production -t kreo-it:production-${{ github.sha }} .

      - name: Save Docker image
        run: |
          docker save kreo-it:production | gzip > kreo-it-production.tar.gz

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          source: "kreo-it-production.tar.gz,docker-compose.yml,docker/nginx-production.conf"
          strip_components: 0
          target: "/opt/kreo-it/"
          overwrite: true

      - name: Deploy and restart on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            set -e
            cd /opt/kreo-it
            
            # Загрузка образа и деплой в одном шаге
            docker load < kreo-it-production.tar.gz
            
            # Остановка и удаление старого контейнера
            docker stop kreo-it-production 2>/dev/null || true
            docker rm -f kreo-it-production 2>/dev/null || true
            
            # Остановка и удаление старого контейнера
            docker stop kreo-it-production 2>/dev/null || true
            docker rm -f kreo-it-production 2>/dev/null || true
            
            # Запуск нового контейнера с проверкой
            echo "=== Запуск контейнера ==="
            CONTAINER_ID=$(docker run -d \
              --name kreo-it-production \
              --restart unless-stopped \
              -p 3001:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              kreo-it:production 2>&1) || {
              echo "❌ Ошибка запуска контейнера: $CONTAINER_ID"
              exit 1
            }
            
            echo "Контейнер запущен: $CONTAINER_ID"
            
            # Ждем запуска
            echo "Ожидание запуска контейнера (20 секунд)..."
            sleep 20
            
            # Проверяем статус
            echo ""
            echo "=== Статус контейнера ==="
            docker ps -a | grep kreo-it-production || echo "❌ Контейнер не найден!"
            
            # Проверяем, запущен ли контейнер
            if ! docker ps | grep -q "kreo-it-production"; then
              echo "❌ Контейнер не запущен! Проверяем логи..."
              echo ""
              echo "=== Логи контейнера (последние 50 строк) ==="
              docker logs kreo-it-production --tail 50 2>&1 || echo "Логи недоступны"
              echo ""
              echo "=== Проверка образа ==="
              docker images | grep kreo-it
              exit 1
            fi
            
            # Проверяем логи
            echo ""
            echo "=== Логи контейнера (последние 50 строк) ==="
            docker logs kreo-it-production --tail 50 2>&1
            
            # Проверяем содержимое контейнера
            echo ""
            echo "=== Содержимое /app в контейнере ==="
            docker exec kreo-it-production ls -la /app 2>&1 | head -20 || echo "Не удалось проверить содержимое"
            
            # Проверяем наличие server.js
            echo ""
            echo "=== Проверка server.js ==="
            docker exec kreo-it-production test -f /app/server.js && echo "✅ server.js найден" || echo "❌ server.js НЕ найден!"
            docker exec kreo-it-production ls -la /app/server.js 2>&1 || echo "Файл не найден"
            
            # Проверяем процесс Node.js
            echo ""
            echo "=== Процессы в контейнере ==="
            docker exec kreo-it-production ps aux 2>&1 || echo "Не удалось проверить процессы"
            
            # Проверяем порт
            echo ""
            echo "=== Проверка порта 3000 внутри контейнера ==="
            docker exec kreo-it-production netstat -tlnp 2>&1 | grep 3000 || docker exec kreo-it-production ss -tlnp 2>&1 | grep 3000 || echo "Порт 3000 не слушается внутри контейнера"
            
            # Проверяем доступность
            echo ""
            echo "=== Проверка доступности с хоста ==="
            for i in {1..10}; do
              if curl -f -s -m 5 http://localhost:3001 > /dev/null 2>&1; then
                echo "✅ Приложение доступно на порту 3001!"
                break
              fi
              echo "Попытка $i/10: ждем..."
              sleep 3
            done
            
            # Финальная проверка
            if ! curl -f -s -m 5 http://localhost:3001 > /dev/null 2>&1; then
              echo ""
              echo "❌ Приложение НЕ доступно после 10 попыток!"
              echo ""
              echo "=== Детальная диагностика ==="
              echo ""
              echo "Статус контейнера (inspect):"
              docker inspect kreo-it-production --format='Status: {{.State.Status}}, Running: {{.State.Running}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}' 2>&1 || echo "Не удалось получить статус"
              echo ""
              echo "Все логи контейнера (последние 100 строк):"
              docker logs kreo-it-production 2>&1 | tail -100
              echo ""
              echo "Проверка порта 3001 на хосте:"
              netstat -tlnp 2>/dev/null | grep 3001 || ss -tlnp 2>/dev/null | grep 3001 || echo "Порт 3001 не слушается"
              echo ""
              echo "Проверка доступности через curl (verbose):"
              curl -v http://localhost:3001 2>&1 | head -30
              echo ""
              echo "Проверка Nginx конфигурации:"
              sudo nginx -t 2>&1
              echo ""
              echo "Ошибки Nginx:"
              sudo tail -20 /var/log/nginx/kreo.pro.error.log 2>/dev/null || echo "Логи Nginx недоступны"
              exit 1
            fi
            
            echo ""
            echo "✅ Приложение успешно запущено и доступно!"
            
            # Обновление Nginx
            if [ -f nginx-production.conf ]; then
              echo "=== Обновление Nginx конфигурации ==="
              
              echo "Содержимое nginx-production.conf (proxy_pass):"
              grep -A 2 "proxy_pass" nginx-production.conf | head -5
              
              echo ""
              echo "Копирование конфигурации:"
              sudo cp nginx-production.conf /etc/nginx/sites-available/kreo.pro
              
              echo ""
              echo "Создание симлинка:"
              [ -L /etc/nginx/sites-enabled/kreo.pro ] && sudo rm /etc/nginx/sites-enabled/kreo.pro || true
              sudo ln -sf /etc/nginx/sites-available/kreo.pro /etc/nginx/sites-enabled/kreo.pro
              
              echo ""
              echo "Проверка конфигурации Nginx:"
              sudo nginx -t 2>&1
              
              if [ $? -ne 0 ]; then
                echo "❌ Ошибка в конфигурации Nginx!"
                exit 1
              fi
              
              echo ""
              echo "Проверка активной конфигурации на сервере (proxy_pass):"
              sudo grep -A 2 "proxy_pass" /etc/nginx/sites-available/kreo.pro | head -5
              
              echo ""
              echo "Проверка всех server блоков для kreo.pro:"
              sudo grep -r "server_name.*kreo.pro" /etc/nginx/sites-enabled/ 2>&1 | head -10
              
              echo ""
              echo "Перезагрузка Nginx (reload):"
              sudo systemctl reload nginx 2>&1
              
              if [ $? -ne 0 ]; then
                echo "❌ Ошибка перезагрузки Nginx! Пробуем restart:"
                sudo systemctl restart nginx 2>&1
              fi
              
              echo ""
              echo "Статус Nginx:"
              sudo systemctl status nginx --no-pager -l | head -15
              
              echo ""
              echo "Проверка, что конфигурация применена:"
              sleep 2
              sudo nginx -T 2>&1 | grep -A 5 "server_name kreo.pro" | grep -A 3 "proxy_pass" | head -10
            else
              echo "⚠️  nginx-production.conf не найден!"
            fi
            
            # Очистка старых образов
            docker image prune -f

      - name: Health check and diagnostics
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            echo "=== Health Check через 15 секунд после деплоя ==="
            sleep 15
            
            echo ""
            echo "=== Статус контейнера ==="
            docker ps -a | grep kreo-it-production || echo "❌ Контейнер не найден!"
            
            echo ""
            echo "=== Детальный статус контейнера ==="
            docker inspect kreo-it-production --format='Status: {{.State.Status}}, Running: {{.State.Running}}, ExitCode: {{.State.ExitCode}}, StartedAt: {{.State.StartedAt}}' 2>&1 || echo "Не удалось получить статус"
            
            echo ""
            echo "=== Логи контейнера (последние 50 строк) ==="
            docker logs kreo-it-production --tail 50 2>&1 || echo "Логи недоступны"
            
            echo ""
            echo "=== Проверка порта 3001 на хосте ==="
            netstat -tlnp 2>/dev/null | grep 3001 || ss -tlnp 2>/dev/null | grep 3001 || echo "❌ Порт 3001 не слушается"
            
            echo ""
            echo "=== Проверка доступности localhost:3001 ==="
            for i in {1..5}; do
              if curl -f -s -m 5 http://localhost:3001 > /dev/null 2>&1; then
                echo "✅ Приложение доступно на localhost:3001 (попытка $i)"
                break
              fi
              echo "Попытка $i/5: приложение еще не готово..."
              sleep 3
            done
            
            echo ""
            echo "=== Проверка процессов в контейнере ==="
            docker exec kreo-it-production ps aux 2>&1 | head -10 || echo "Не удалось проверить процессы (контейнер может быть остановлен)"
            
            echo ""
            echo "=== Проверка порта 3000 внутри контейнера ==="
            docker exec kreo-it-production netstat -tlnp 2>&1 | grep 3000 || docker exec kreo-it-production ss -tlnp 2>&1 | grep 3000 || echo "Порт 3000 не слушается внутри контейнера"
            
            echo ""
            echo "=== Проверка логов Nginx ==="
            echo "Поиск логов Nginx:"
            sudo find /var/log/nginx -name "*kreo*" -o -name "*error*" 2>/dev/null | head -5 || echo "Логи не найдены"
            
            echo ""
            echo "Ошибки Nginx (все возможные места):"
            sudo tail -30 /var/log/nginx/kreo.pro.error.log 2>/dev/null || \
            sudo tail -30 /var/log/nginx/error.log 2>/dev/null || \
            echo "Логи ошибок недоступны"
            
            echo ""
            echo "Access логи Nginx:"
            sudo tail -10 /var/log/nginx/kreo.pro.access.log 2>/dev/null || \
            sudo tail -10 /var/log/nginx/access.log 2>/dev/null || \
            echo "Access логи недоступны"
            
            echo ""
            echo "=== Проверка конфигурации Nginx на сервере ==="
            echo "Проверка синтаксиса:"
            sudo nginx -t 2>&1
            
            echo ""
            echo "Активная конфигурация proxy_pass:"
            sudo grep -A 5 "location /" /etc/nginx/sites-available/kreo.pro 2>/dev/null || \
            sudo grep -A 5 "location /" /etc/nginx/sites-enabled/kreo.pro 2>/dev/null || \
            echo "Конфигурация не найдена"
            
            echo ""
            echo "=== Проверка доступности через Nginx (HTTPS) ==="
            curl -k -v https://localhost 2>&1 | head -40 || echo "Не удалось проверить HTTPS"
            
            echo ""
            echo "=== Проверка подключения Nginx к приложению ==="
            echo "Тест подключения от имени Nginx пользователя:"
            sudo -u www-data curl -v http://127.0.0.1:3001 2>&1 | head -20 || echo "Не удалось подключиться от имени www-data"
            
            echo ""
            echo "=== Проверка всех активных Nginx конфигураций ==="
            echo "Сайты в sites-enabled:"
            ls -la /etc/nginx/sites-enabled/ 2>&1 || echo "Директория не найдена"
            
            echo ""
            echo "Проверка всех server блоков с kreo.pro:"
            sudo grep -r "server_name.*kreo" /etc/nginx/ 2>&1 | head -10 || echo "Не найдено"
            
            echo ""
            echo "=== Проверка доступности через Nginx ==="
            curl -v -H "Host: kreo.pro" http://127.0.0.1 2>&1 | head -30 || echo "Не удалось проверить через Nginx"
            
            echo ""
            echo "=== Финальная проверка health ==="
            if curl -f -s -m 5 http://localhost:3001 > /dev/null 2>&1; then
              echo "✅ Health check пройден!"
            else
              echo "❌ Health check провален!"
              echo ""
              echo "=== Дополнительная диагностика ==="
              echo "Статус контейнера:"
              docker ps -a | grep kreo-it-production
              echo ""
              echo "Последние логи:"
              docker logs kreo-it-production --tail 50 2>&1
              exit 1
            fi


      - name: Notify success
        if: success()
        run: |
          echo "✅ Deployment to kreo.pro successful!"

      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Deployment to kreo.pro failed!"

