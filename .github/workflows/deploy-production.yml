name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch: # Позволяет запускать вручную из GitHub UI

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint
        continue-on-error: true

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: https://kreo.pro
          NEXT_PUBLIC_API_URL: https://api.kreo.pro

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (optional)
        if: env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -f docker/Dockerfile -t kreo-it:production -t kreo-it:production-${{ github.sha }} .

      - name: Save Docker image
        run: |
          docker save kreo-it:production | gzip > kreo-it-production.tar.gz

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          source: "kreo-it-production.tar.gz,docker-compose.yml,docker/nginx-production.conf"
          strip_components: 0
          target: "/opt/kreo-it/"
          overwrite: true

      - name: Verify files copied
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            cd /opt/kreo-it
            ls -lh kreo-it-production.tar.gz docker-compose.yml nginx-production.conf || echo "⚠️  Nginx config not found, continuing..."
            echo "Checking docker-compose.yml content:"
            grep -A 2 "image:" docker-compose.yml || echo "ERROR: docker-compose.yml not updated!"

      - name: Backup current version
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            cd /opt/kreo-it
            docker save kreo-it:production > backup-$(date +%Y%m%d-%H%M%S).tar 2>/dev/null || true

      - name: Deploy and restart on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            cd /opt/kreo-it
            docker load < kreo-it-production.tar.gz || true
            docker compose stop landing || true
            docker compose rm -f landing || true
            docker compose up -d landing
            sleep 10
            # Обновление Nginx конфигурации
            if [ -f nginx-production.conf ]; then
              sudo cp nginx-production.conf /etc/nginx/sites-available/kreo.pro
              if [ ! -L /etc/nginx/sites-enabled/kreo.pro ]; then
                sudo ln -s /etc/nginx/sites-available/kreo.pro /etc/nginx/sites-enabled/kreo.pro
              fi
              sudo nginx -t && sudo systemctl reload nginx || echo "⚠️  Ошибка перезагрузки Nginx"
            fi
            docker system prune -f

      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            sleep 15
            # Проверяем статус контейнера
            docker compose ps landing
            # Проверяем доступность приложения
            curl -f http://localhost:3001/health || curl -f http://localhost:3001 || (echo "Health check failed" && docker compose logs landing --tail 50 && exit 1)

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            cd /opt/kreo-it
            LATEST_BACKUP=$(ls -t backup-*.tar 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              docker load < $LATEST_BACKUP
              docker compose up -d landing
            fi

      - name: Notify success
        if: success()
        run: |
          echo "✅ Deployment to kreo.pro successful!"

      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Deployment to kreo.pro failed!"

